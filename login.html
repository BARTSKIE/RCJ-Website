<!-- login.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - RCJ Optical</title>
    <link rel="icon" type="image/png" href="images/RCJ.png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/chatbot.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="auth-body">
    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo">
                <h1>RCJ <span>Optical</span></h1>
                <p>Clinic & Vision Center</p>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="services.html">Services</a></li>
                    <li><a href="about.html">Our Team</a></li>
                    <li><a href="feedback-form.html">Feedback</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="support.html">Support</a></li>
                    <!-- Add these authentication links -->
                    <li id="authLinks">
                        <!-- These will be shown when user is NOT logged in -->
                        <a href="login.html" class="auth-link login-link">Login</a>
                    </li>
                    <!-- User menu (will be shown when logged in) -->
                    <li id="userMenu" style="display: none;">
                        <div class="user-dropdown">
                            <button class="user-btn">
                                <i class="fas fa-user-circle"></i>
                                <span id="userName">User</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-content">
                                <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
                                <a href="support.html"><i class="fas fa-headset"></i> Customer Support</a>
                                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                            </div>
                        </div>
                    </li>
                </ul>
            </nav>
            <div class="menu-toggle"><i class="fas fa-bars"></i></div>
        </div>
    </header>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="logo">
                    <h1>RCJ <span>Optical</span></h1>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">Mobile App Account Login</p>
                </div>
                <h2>Welcome Back</h2>
                <p>Sign in with your mobile app account</p>
            </div>

            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required placeholder="Enter your email">
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required placeholder="Enter your password">
                    <button type="button" id="togglePassword" class="toggle-password">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>

                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <span>Remember me</span>
                    </label>
                    <a href="forgot-password.html" class="forgot-password">Forgot password?</a>
                </div>

                <button type="submit" class="btn btn-primary btn-full" id="loginBtn">
                    <span>Sign In</span>
                    <div class="loading-spinner" style="display: none;"></div>
                </button>

                <div class="auth-divider">
                    <span>Don't have an account?</span>
                </div>

                <div class="mobile-app-note">
                    <p style="text-align: center; color: #666; font-size: 0.9rem;">
                        <i class="fas fa-mobile-alt"></i><br>
                        Account registration is available through<br>our mobile app only for security purposes
                    </p>
                </div>
            </form>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>
        </div>

        <div class="auth-footer">
            <p>&copy; 2024 RCJ Optical. All rights reserved.</p>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div id="verificationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Email Verification Required</h3>
                <button type="button" class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="verification-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <p>Please verify your email address before accessing your account.</p>
                <p>A verification email was sent to <strong id="userEmail"></strong></p>
                <div class="verification-actions">
                    <button id="continueToHome" class="btn btn-secondary">Continue to Homepage</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Container -->
    <div id="chatbot-container" class="chatbot-container">
        <div class="chatbot-header">
            <h4>RCJ Optical Assistant</h4>
            <p>How can we help you today?</p>
            <button id="close-chatbot" class="close-chatbot">Ã—</button>
        </div>
        
        <div id="chatbot-messages" class="chatbot-messages">
            <!-- Messages will appear here -->
        </div>
        
        <div id="chatbot-quick-replies" class="chatbot-quick-replies">
            <!-- Quick reply buttons will appear here -->
        </div>
        
        <div class="chatbot-input">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button id="send-message">âž¤</button>
        </div>
    </div>

    <!-- Chatbot Trigger -->
    <button id="chatbot-trigger" class="chatbot-trigger">
        ðŸ’¬ <span>Chat with us</span>
    </button>


    <script type="module" src="js/update-navigation.js"></script>
    
    <script type="module">
    import { auth } from './js/firebase-config.js';

    console.log('=== MANUAL LOGIN TEST ===');
    console.log('Clean login page loaded');
    console.log('URL parameters:', window.location.search);

    // Check if form gets auto-filled
    document.addEventListener('DOMContentLoaded', function() {
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        
        console.log('Form inputs on load:');
        console.log('Email input value:', emailInput?.value);
        console.log('Password input value:', passwordInput?.value ? '***' : 'empty');
    });
    </script>

    <script type="module">
    import { auth } from './js/firebase-config.js';

    // Debug login flow
    console.log('=== LOGIN PAGE DEBUG ===');
    console.log('Current user on login page:', auth.currentUser);

    // Listen for auth changes during login
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    onAuthStateChanged(auth, (user) => {
        console.log('Login page auth state changed:', user ? user.email : 'No user');
    });
    </script>
    <script type="module">
    import { auth } from './js/firebase-config.js';
    import { 
        signInWithEmailAndPassword,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

    document.addEventListener('DOMContentLoaded', function() {
        // 1. FIX PASSWORD VISIBILITY TOGGLE
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        
        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                // Toggle eye icon
                const icon = this.querySelector('i');
                if (type === 'text') {
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }

        // 2. AUTO-FILL FORM FROM URL PARAMETERS
        function getUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            const email = params.get('email');
            const password = params.get('password');
            
            return { email, password };
        }

        function autoFillForm() {
            const { email, password } = getUrlParameters();
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            if (email && emailInput) {
                // Decode URL-encoded email
                emailInput.value = decodeURIComponent(email);
                console.log('Auto-filled email:', emailInput.value);
            }
            
            if (password && passwordInput) {
                // Decode URL-encoded password
                passwordInput.value = decodeURIComponent(password);
                console.log('Auto-filled password: ***');
            }
        }

        // Call auto-fill when page loads
        autoFillForm();

        // 3. HANDLE FORM SUBMISSION
        const loginForm = document.getElementById('loginForm');
        const loginBtn = document.getElementById('loginBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        if (loginForm) {
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('rememberMe').checked;

                // Show loading state
                loginBtn.disabled = true;
                loginBtn.querySelector('span').style.display = 'none';
                loginBtn.querySelector('.loading-spinner').style.display = 'block';
                
                // Hide previous messages
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';

                try {
                    console.log('Attempting login with:', email);
                    
                    // Sign in with Firebase
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('Login successful:', user.email);
                    
                    // Check if email is verified
                    if (!user.emailVerified) {
                        // Show verification modal
                        showVerificationModal(user.email);
                        return;
                    }
                    
                    // Show success message
                    successMessage.textContent = 'Login successful! Redirecting...';
                    successMessage.style.display = 'block';
                    
                    // Redirect to home page after successful login
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    
                } catch (error) {
                    console.error('Login error:', error);
                    
                    // Show appropriate error message
                    let errorMsg = 'Login failed. Please try again.';
                    
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMsg = 'Invalid email address.';
                            break;
                        case 'auth/user-disabled':
                            errorMsg = 'This account has been disabled.';
                            break;
                        case 'auth/user-not-found':
                            errorMsg = 'No account found with this email.';
                            break;
                        case 'auth/wrong-password':
                            errorMsg = 'Incorrect password. Please try again.';
                            break;
                        case 'auth/too-many-requests':
                            errorMsg = 'Too many failed attempts. Please try again later.';
                            break;
                    }
                    
                    errorMessage.textContent = errorMsg;
                    errorMessage.style.display = 'block';
                    
                    // Scroll to error message
                    errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                } finally {
                    // Reset loading state
                    loginBtn.disabled = false;
                    loginBtn.querySelector('span').style.display = 'block';
                    loginBtn.querySelector('.loading-spinner').style.display = 'none';
                }
            });
        }

        // 4. VERIFICATION MODAL FUNCTIONS
        function showVerificationModal(email) {
            const modal = document.getElementById('verificationModal');
            const userEmail = document.getElementById('userEmail');
            const closeModal = document.querySelector('.close-modal');
            const continueToHome = document.getElementById('continueToHome');
            
            if (userEmail) {
                userEmail.textContent = email;
            }
            
            if (modal) {
                modal.style.display = 'block';
            }
            
            // Close modal events
            if (closeModal) {
                closeModal.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }
            
            if (continueToHome) {
                continueToHome.addEventListener('click', function() {
                    window.location.href = 'index.html';
                });
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // 5. LISTEN FOR AUTH STATE CHANGES (for auto-redirect if already logged in)
        onAuthStateChanged(auth, (user) => {
            if (user && user.emailVerified) {
                console.log('User already logged in, redirecting...');
                // User is already logged in and verified, redirect to home
                window.location.href = 'index.html';
            }
        });
    });
</script>
</body>
</html>